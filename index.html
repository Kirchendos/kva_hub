<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–í–ê 3003</title>
  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #f0f0f0;
      text-align: center;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
      background: #333;
      color: white;
      border: none;
      border-radius: 5px;
      transition: background 0.3s;
    }
    button:hover { background: #444; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .header h1 { margin: 0; }
    .data-controls {
      display: flex;
      gap: 5px;
    }
    .data-controls button {
      padding: 8px 12px;
      font-size: 14px;
      margin: 0;
      background: #2c3e50;
    }
    .data-controls button:hover { background: #34495e; }
    #result {
      margin-top: 20px;
      font-size: 18px;
      background: #222;
      padding: 15px;
      border-radius: 8px;
      position: relative;
    }
    #events {
      margin-top: 20px;
      text-align: left;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .event {
      margin-bottom: 10px;
      padding: 10px;
      background: #1c1c1c;
      border-left: 4px solid #888;
      position: relative;
      padding-right: 120px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-content {
      flex-grow: 1;
      padding-right: 40px;
    }
    .event-time {
      position: absolute;
      right: 60px;
      top: 10px;
      font-size: 12px;
      color: #888;
      font-style: italic;
      text-align: right;
      line-height: 1.3;
      min-width: 80px;
    }
    .current-event-time {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 14px;
      color: #aaa;
      font-style: italic;
      text-align: right;
      line-height: 1.3;
    }
    #scoreboard {
      margin-top: 15px;
      font-size: 20px;
    }
    #scoreboard button {
      width: 50px;
      margin: 5px;
      font-size: 18px;
    }
    #scoreboard span {
      margin-right: 15px;
      font-weight: bold;
    }
    #total-games {
      margin-top: 10px;
      font-size: 18px;
      opacity: 0.9;
    }
    .score-section {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 30px 0;
      flex-wrap: wrap;
      align-items: stretch;
    }
    #round-score-container {
      text-align: center;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      min-width: 300px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 350px;
    }
    #chart-container {
      background: #1a1a1a;
      padding: 18px 20px 15px;
      border-radius: 10px;
      min-width: 300px;
      flex: 1;
      height: 350px;
      position: relative;
    }
    .score-input {
      width: 90px;
      margin: 7.5px 15px;
      text-align: center;
      padding: 7.5px;
      font-size: 24px;
      background: #222;
      color: white;
      border: 1px solid #555;
      border-radius: 4px;
    }
    .points-total {
      font-weight: bold;
      margin-top: 7.5px;
      font-size: 27px;
      color: #4CAF50;
    }
    .round-controls {
      margin-top: auto;
      padding-top: 20px;
    }
    .section-title {
      font-size: 22px;
      margin: 25px 0 15px 0;
      color: #ccc;
    }
    .player-row { margin: 15px 0; }
    .input-label {
      display: inline-block;
      width: 45px;
      text-align: left;
      font-size: 24px;
    }
    #points-chart {
      width: 100% !important;
      height: 280px !important;
      margin-top: 10px;
    }
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 5px;
      font-size: 16px;
      position: static;
      bottom: 10px;
      margin-bottom: 5px;
      left: 0;
      right: 0;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    .k-color { background-color: #FF6B6B; }
    .v-color { background-color: #4ECDC4; }
    .a-color { background-color: #FFD166; }
    .inputs-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    #file-input { display: none; }
    .file-label {
      display: inline-block;
      padding: 8px 12px;
      background: #3498db;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .file-label:hover { background: #2980b9; }
    .backup-info {
      font-size: 12px;
      color: #888;
      margin-top: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .main-controls { margin-bottom: 20px; }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 10px;
      }
      .data-controls { justify-content: center; }
      .event-time {
        position: static;
        text-align: left;
        margin-top: 5px;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞ */
    #custom-event-dialog button {
      padding: 8px 16px;
      font-size: 14px;
      margin: 0;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    #custom-event-dialog button:hover {
      opacity: 0.9;
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∏–≤–µ–Ω—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
    .event.custom-event {
      border-left-color: #4CAF50;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
    .delete-event-btn {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      padding: 5px 8px;
      margin-left: 10px;
      border-radius: 4px;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .delete-event-btn:hover {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }
    
    .events-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">
    <div style="display: flex; align-items: center; gap: 10px;">
      <h1>üÉè –ö–í–ê 3003</h1>
      <button id="info-button" title="–°–Ω–æ—Å–∫–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è" onclick="toggleInfoPopup()" style="
        background: transparent;
        border: 1px solid #555;
        border-radius: 50%;
        color: #aaa;
        font-size: 16px;
        font-weight: bold;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      ">i</button>
    </div>
    
    <div class="data-controls">
      <button onclick="DataManager.exportData()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <label for="file-input" class="file-label" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞">üìÅ –ò–º–ø–æ—Ä—Ç</label>
      <input type="file" id="file-input" accept=".json" onchange="DataManager.importData(event)">
    </div>
  </div>

  <div class="main-controls">
    <button onclick="toggleCircleArrow()" id="circle-arrow-clicker" title="–ö–ª–∏–∫–Ω–∏ –¥–ª—è —Å–º–µ–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è" style="font-size: 22px;">‚Üª</button>
    <button onclick="EventManager.rollEvent()">üé≤ –ù–æ–≤—ã–π –∏–≤–µ–Ω—Ç</button>
    <button onclick="CustomEventManager.openDialog()">‚úçÔ∏è –°–≤–æ–π –∏–≤–µ–Ω—Ç</button>
    <button onclick="EventManager.resetGame()">üßº –°–±—Ä–æ—Å –∏–≤–µ–Ω—Ç–æ–≤</button>
    <button onclick="ScoreManager.resetWins()">üî• –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–±–µ–¥—ã</button>
  </div>
  
  <div class="backup-info">
    üí° 5 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥–æ–¥–∞ ‚Äî —É–¥–∞—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –∏ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–ª—è —Ä–∞–±–æ—Ç—ã. <br>–ù–ê–ß–ò–ù–ê–ï–ú –ö–í–ê 3003!!!!!
  </div>

  <div class="section-title">üèÜ –°—á—ë—Ç –ø–æ–±–µ–¥</div>
  <div id="scoreboard">
    <button onclick="ScoreManager.addWin('K')">–ö</button><span id="score-K">0</span>
    <button onclick="ScoreManager.addWin('V')">–í</button><span id="score-V">0</span>
    <button onclick="ScoreManager.addWin('A')">–ê</button><span id="score-A">0</span>
  </div>
  <div id="total-games">üéÆ –í—Å–µ–≥–æ —Å—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä: <strong id="total-count">0</strong></div>

  <div class="section-title">üìä –°—á—ë—Ç –æ—á–∫–æ–≤</div>
  <div class="score-section">
    <div id="round-score-container">
      <div class="inputs-container">
        <div class="player-row">
          <span class="input-label">–ö:</span>
          <input type="number" class="score-input" id="round-score-K" min="0" placeholder="0">
          <span class="points-total">–ò—Ç–æ–≥–æ: <span id="total-points-K">0</span></span>
        </div>
        <div class="player-row">
          <span class="input-label">–í:</span>
          <input type="number" class="score-input" id="round-score-V" min="0" placeholder="0">
          <span class="points-total">–ò—Ç–æ–≥–æ: <span id="total-points-V">0</span></span>
        </div>
        <div class="player-row">
          <span class="input-label">–ê:</span>
          <input type="number" class="score-input" id="round-score-A" min="0" placeholder="0">
          <span class="points-total">–ò—Ç–æ–≥–æ: <span id="total-points-A">0</span></span>
        </div>
      </div>
      <div class="round-controls">
        <button onclick="PointsManager.addRoundPoints()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏</button>
        <button onclick="PointsManager.resetAllPoints()">üî• –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—á–∫–∏</button>
      </div>
    </div>
    <div id="chart-container">
      <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –æ—á–∫–æ–≤ –ø–æ —Ä–∞—É–Ω–¥–∞–º</div>
      <canvas id="points-chart"></canvas>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-color k-color"></div><span>–ö</span></div>
        <div class="legend-item"><div class="legend-color v-color"></div><span>–í</span></div>
        <div class="legend-item"><div class="legend-color a-color"></div><span>–ê</span></div>
      </div>
    </div>
  </div>
  
  <!-- –î–∏–∞–ª–æ–≥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–µ–≥–æ –∏–≤–µ–Ω—Ç–∞ -->
  <div id="custom-event-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #222; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; border: 2px solid #444;">
      <h3 style="margin-top: 0; color: #fff;">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –∏–≤–µ–Ω—Ç</h3>
      <div style="margin-bottom: 15px; color: #aaa;">
        –í–≤–µ–¥–∏—Ç–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤—Ä—É—á–Ω—É—é:
      </div>
      <textarea id="custom-event-text" style="width: 100%; height: 120px; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; font-size: 16px; resize: vertical;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Ç—É–∑ ‚Äî –≤—Å–µ –∏–≥—Ä–æ–∫–∏ ‚Äî –±–µ—Ä—É—Ç 1 –∫–∞—Ä—Ç—É"></textarea>
      <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="CustomEventManager.closeDialog()" style="background: #666;">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="CustomEventManager.addCustomEvent()" style="background: #4CAF50;">–î–æ–±–∞–≤–∏—Ç—å –∏–≤–µ–Ω—Ç</button>
      </div>
    </div>
  </div>
  
  <div id="result"></div>
  
  <div id="events">
    <div class="events-header">
      <h3 style="margin: 0;">–ü—Ä–æ—à–ª—ã–µ –∏–≤–µ–Ω—Ç—ã</h3>
      <button onclick="EventManager.clearAllEvents()" style="font-size: 14px; padding: 5px 10px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
    </div>
  </div>

<script>
// ============ –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
const TRIGGERS = [
  // –ë–∞–∑–æ–≤—ã–µ –∏–≥—Ä–æ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Ç—É–∑',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä–æ–ª—å',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–∞–º–∞',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤–∞–ª–µ—Ç',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Å–µ–º–µ—Ä–∫–∞',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤–æ—Å—å–º–µ—Ä–∫–∞',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —à–µ—Å—Ç–µ—Ä–∫–∞',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–µ–≤—è—Ç–∫–∞',
  '–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è —Å –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ–π',
  '–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∫–ª–∞–¥–µ—Ç –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—é—é –∫–∞—Ä—Ç—É',
  '–ö–æ–≥–¥–∞ –∫–æ–ª–æ–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è',
  
  // –ö–∞—Ä—Ç—ã-—Å–æ–±—ã—Ç–∏—è (—Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –º–∞—Å—Ç—è–º–∏)
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –ø–∏–∫–æ–≤—ã–π –∫–æ—Ä–æ–ª—å',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–≤–æ–π–∫–∞ –±—É–±–µ–π',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –ø—è—Ç–µ—Ä–∫–∞ –±—É–±–µ–π',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Ç—Ä–æ–π–∫–∞ —á–µ—Ä–≤–µ–π',
  '–ö–æ–≥–¥–∞ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —á–µ—Ç–≤–µ—Ä–∫–∞ —Ç—Ä–µ—Ñ',
  
  // –ò–≥—Ä–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
  '–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –±–µ—Ä–µ—Ç –∫–∞—Ä—Ç—É –∏–∑ –∫–æ–ª–æ–¥—ã',
  '–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã–∏–≥—Ä–∞–ª –ø—Ä–æ—à–ª—ã–π —Ä–∞—É–Ω–¥',
  '–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø—Ä–æ–∏–≥—Ä–∞–ª –ø—Ä–æ—à–ª—ã–π —Ä–∞—É–Ω–¥',
  '–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—Ä—É–≥–∞ —Ö–æ–¥–æ–≤',
  '–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ö–æ–¥–∞ –∏–≥—Ä–æ–∫–∞',
  '–ö–æ–≥–¥–∞ —Ü–µ–ø–æ—á–∫–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–∞—Ä—Ç –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è',
  '–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥',
  '–ï—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ 5 –∏–ª–∏ –±–æ–ª–µ–µ –∫–∞—Ä—Ç',
  '–ï—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ 2 –∏–ª–∏ –º–µ–Ω—å—à–µ –∫–∞—Ä—Ç',
  '–ö–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ–¥–∞'
];

const ACTIONS = [
  // –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
  '—Å–ª–µ–¥—É—é—â–∏–π –∏–≥—Ä–æ–∫',
  '–ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–≥—Ä–æ–∫',
  '–≤—Å–µ –∏–≥—Ä–æ–∫–∏',
  '–∏–≥—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ª–æ–∂–∏–ª –∫–∞—Ä—Ç—É',
  '–∏–≥—Ä–æ–∫ —Å–ø—Ä–∞–≤–∞',
  '–∏–≥—Ä–æ–∫ —Å–ª–µ–≤–∞',
  
  // –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Ü–µ–ª–∏
  '–∏–≥—Ä–æ–∫ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ä—Ç',
  '–∏–≥—Ä–æ–∫ —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ä—Ç',
  '–∏–≥—Ä–æ–∫ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–∫–æ–≤',
  '–∏–≥—Ä–æ–∫ —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–∫–æ–≤',
  '–∏–≥—Ä–æ–∫, –Ω–∞—á–∞–≤—à–∏–π —Ä–∞—É–Ω–¥',
  '–∏–≥—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Ö–æ–¥–∏—Ç—å',
  
  // –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ü–µ–ª–∏
  '–≤—Å–µ, –∫—Ä–æ–º–µ –≤—ã–ª–æ–∂–∏–≤—à–µ–≥–æ –∫–∞—Ä—Ç—É',
  '–≤—Å–µ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º —Ä–∞—É–Ω–¥–µ',
  '–≤—ã–∏–≥—Ä–∞–≤—à–∏–π –≤ –ø—Ä–æ—à–ª–æ–º —Ä–∞—É–Ω–¥–µ –∏–≥—Ä–æ–∫',
  '–∏–≥—Ä–æ–∫–∏ —Å —á–µ—Ç–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ä—Ç',
  '–∏–≥—Ä–æ–∫–∏ —Å –Ω–µ—á–µ—Ç–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ä—Ç',
  '—Å–ª—É—á–∞–π–Ω—ã–π –∏–≥—Ä–æ–∫'
];

const EFFECTS = [
  // –ü—Ä–æ—Å—Ç—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–æ—Å–Ω–æ–≤–∞)
  '–±–µ—Ä–µ—Ç 1 –∫–∞—Ä—Ç—É',
  '–±–µ—Ä–µ—Ç 2 –∫–∞—Ä—Ç—ã',
  '–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥',
  '–ø–æ–ª—É—á–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ö–æ–¥',
  '—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É',
  '–º–æ–∂–µ—Ç –∑–∞–∫–∞–∑–∞—Ç—å –ª—é–±—É—é –º–∞—Å—Ç—å',
  '–º–µ–Ω—è–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ–¥–∞',
  '–∏–≥—Ä–∞–µ—Ç —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞—É–Ω–¥–∞',
  '–æ–±–º–µ–Ω–∏–≤–∞–µ—Ç—Å—è —Ä—É–∫–æ–π —Å —Å–æ—Å–µ–¥–æ–º —Å–ª–µ–≤–∞',
  '–æ–±–º–µ–Ω–∏–≤–∞–µ—Ç—Å—è —Ä—É–∫–æ–π —Å —Å–æ—Å–µ–¥–æ–º —Å–ø—Ä–∞–≤–∞',
  '–æ—Ç–º–µ–Ω—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç —ç—Ç–æ–π –∫–∞—Ä—Ç—ã',
  '–¥–æ–ª–∂–µ–Ω –ø–æ–ª–æ–∂–∏—Ç—å –∫–∞—Ä—Ç—É —Ç–æ–≥–æ –∂–µ —Ü–≤–µ—Ç–∞',
  '–¥–æ–ª–∂–µ–Ω –ø–æ–ª–æ–∂–∏—Ç—å –∫–∞—Ä—Ç—É —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞',
  
  // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å –∫—É–±–∏–∫–∞–º–∏ (–Ω–µ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ)
  '–±—Ä–æ—Å–∞–µ—Ç d4 –∏ –±–µ—Ä–µ—Ç —Å—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç',
  '–±—Ä–æ—Å–∞–µ—Ç d6: —á–µ—Ç–Ω–æ–µ = –±–µ—Ä–µ—Ç 2 –∫–∞—Ä—Ç—ã, –Ω–µ—á–µ—Ç–Ω–æ–µ = –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥',
  '–±—Ä–æ—Å–∞–µ—Ç d8: –µ—Å–ª–∏ –±–æ–ª—å—à–µ 4, –≤—Å–µ –±–µ—Ä—É—Ç –ø–æ 1 –∫–∞—Ä—Ç–µ',
  '–±—Ä–æ—Å–∞–µ—Ç d10: –±–µ—Ä–µ—Ç –∫–∞—Ä—Ç = –ø–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞ (0 = 10)',
  '–±—Ä–æ—Å–∞–µ—Ç d12: –ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ = —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç 2 –∫–∞—Ä—Ç—ã',
  '–±—Ä–æ—Å–∞–µ—Ç d20: 1-10 = –±–µ—Ä–µ—Ç 1 –∫–∞—Ä—Ç—É, 11-20 = —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç 1 –∫–∞—Ä—Ç—É',
  '–±—Ä–æ—Å–∞–µ—Ç d100: –µ—Å–ª–∏ ‚â§50, –±–µ—Ä–µ—Ç 3 –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ >50, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–µ—Ä—É—Ç –ø–æ 2',
  
  // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∞ (—Ä–µ–¥–∫–æ)
  '–º–µ–Ω—è–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ–¥–∞ + —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —Å –º–µ–ª–∫–∏–º–∏ –∫–∞—Ä—Ç–∞–º–∏',
  '–±–µ—Ä–µ—Ç 2 –∫–∞—Ä—Ç—ã + —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —Å –æ–≥—Ä–æ–º–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏',
  '–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥ + —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏',
  '–ø–æ–ª—É—á–∞–µ—Ç –¥–æ–ø. —Ö–æ–¥ + —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —Å –¥–≤–æ–π–Ω–æ–π –∫–æ–ª–æ–¥–æ–π',
  '—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—É + —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –∏–≥—Ä–∞–µ–º –≤—Å–µ–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏',
  '–æ—Ç–º–µ–Ω—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç + —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —Å 36 –∫–∞—Ä—Ç–∞–º–∏',
  
  // –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏
  '–º–æ–∂–µ—Ç –≤—ã–ª–æ–∂–∏—Ç—å –≤—Ç–æ—Ä—É—é –∫–∞—Ä—Ç—É —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞',
  '—Ç—è–Ω–µ—Ç –∫–∞—Ä—Ç—ã –∏–∑ —Ä—É–∫–∏ —Å–¥–µ–ª–∞–≤—à–µ–≥–æ —Ö–æ–¥',
  '–ø–µ—Ä–µ–¥–∞–µ—Ç —Å–≤–æ—é —Ä—É–∫—É —Å–ª–µ–¥—É—é—â–µ–º—É –∏–≥—Ä–æ–∫—É',
  '–º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–µ—Ä—Ö–Ω–∏–µ 3 –∫–∞—Ä—Ç—ã –∫–æ–ª–æ–¥—ã',
  '–≤—Å–µ –∫–∞—Ä—Ç—ã –º–µ–Ω—è—é—Ç –º–∞—Å—Ç—å –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é',
  '–º–æ–∂–µ—Ç "—É–∫—Ä–∞—Å—Ç—å" –æ–¥–Ω—É –∫–∞—Ä—Ç—É –∏–∑ —Å–±—Ä–æ—Å–∞',
];

const COLORS = {
  K: '#FF6B6B',
  V: '#4ECDC4',
  A: '#FFD166'
};

// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
const State = {
  activeEvents: [],
  wins: { K: 0, V: 0, A: 0 },
  points: { K: 0, V: 0, A: 0 },
  pointsHistory: { K: [], V: [], A: [] },
  chart: null
};

// ============ –£–¢–ò–õ–ò–¢–´ ============
const Utils = {
  randomChoice: arr => arr[Math.floor(Math.random() * arr.length)],
  
  formatDateTime(date) {
    const pad = n => n.toString().padStart(2, '0');
    return {
      date: `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()}`,
      time: `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`,
      full: `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`
    };
  },
  
  showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      animation: fadeInOut 2s ease-in-out;
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 2000);
  }
};

// ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò (DATA MANAGER) ============
const DataManager = {
  STORAGE_KEYS: {
    WINS: 'kva_wins',
    POINTS: 'kva_points',
    HISTORY: 'kva_pointsHistory',
    EVENTS: 'kva_activeEvents',
    CURRENT_EVENT: 'kva_currentEvent',
    BACKUP: 'kva_backup'
  },
  
  loadAllData() {
    this._loadFromStorage(this.STORAGE_KEYS.WINS, 'wins');
    this._loadFromStorage(this.STORAGE_KEYS.POINTS, 'points');
    this._loadFromStorage(this.STORAGE_KEYS.HISTORY, 'pointsHistory');
    this._loadFromStorage(this.STORAGE_KEYS.EVENTS, 'activeEvents');
    
    const currentEvent = localStorage.getItem(this.STORAGE_KEYS.CURRENT_EVENT);
    if (currentEvent) document.getElementById('result').innerHTML = currentEvent;
  },
  
  _loadFromStorage(key, stateProp) {
    const saved = localStorage.getItem(key);
    if (saved) {
      try {
        State[stateProp] = JSON.parse(saved);
      } catch (e) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${key}:`, e);
      }
    }
  },
  
  exportData() {
    const exportData = {
      version: '2.0',
      exportDate: new Date().toISOString(),
      wins: State.wins,
      points: State.points,
      pointsHistory: State.pointsHistory,
      activeEvents: State.activeEvents,
      currentEvent: document.getElementById('result').innerHTML
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    const date = new Date();
    const filename = `kva3003_backup_${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}.json`;
    
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
    Utils.showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
  },
  
  importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const importedData = JSON.parse(e.target.result);
        if (!importedData.wins || !importedData.points) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        
        if (!confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏?\n\n–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date(importedData.exportDate || Date.now()).toLocaleString()}\n\n–≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.`)) return;
        
        // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        State.wins = importedData.wins;
        State.points = importedData.points;
        State.activeEvents = importedData.activeEvents || [];
        State.pointsHistory = importedData.pointsHistory || { K: [State.points.K], V: [State.points.V], A: [State.points.A] };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        ScoreManager.updateWinsDisplay();
        PointsManager.updatePointsDisplay();
        ScoreManager.updateTotalGames();
        ChartManager.updateChart();
        EventManager.renderEvents();
        
        if (importedData.currentEvent) {
          document.getElementById('result').innerHTML = importedData.currentEvent;
        } else {
          document.getElementById('result').innerHTML = '';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        this.saveAll();
        event.target.value = '';
        Utils.showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö: —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.');
        event.target.value = '';
      }
    };
    reader.readAsText(file);
  },
  
  createBackup() {
    const backupData = {
      version: '2.0',
      backupDate: new Date().toISOString(),
      wins: State.wins,
      points: State.points,
      pointsHistory: State.pointsHistory,
      activeEvents: State.activeEvents,
      currentEvent: document.getElementById('result').innerHTML
    };
    localStorage.setItem(this.STORAGE_KEYS.BACKUP, JSON.stringify(backupData));
    Utils.showNotification('‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
  },
  
  restoreBackup() {
    const backup = localStorage.getItem(this.STORAGE_KEYS.BACKUP);
    if (!backup) {
      alert('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage.');
      return;
    }
    
    if (confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏–∑ localStorage?\n\n–≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.')) {
      try {
        const backupData = JSON.parse(backup);
        State.wins = backupData.wins;
        State.points = backupData.points;
        State.activeEvents = backupData.activeEvents || [];
        State.pointsHistory = backupData.pointsHistory || { K: [], V: [], A: [] };
        
        ScoreManager.updateWinsDisplay();
        PointsManager.updatePointsDisplay();
        ScoreManager.updateTotalGames();
        ChartManager.updateChart();
        EventManager.renderEvents();
        
        if (backupData.currentEvent) {
          document.getElementById('result').innerHTML = backupData.currentEvent;
        }
        
        this.saveAll();
        Utils.showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏!');
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.');
      }
    }
  },
  
  saveAll() {
    localStorage.setItem(this.STORAGE_KEYS.WINS, JSON.stringify(State.wins));
    localStorage.setItem(this.STORAGE_KEYS.POINTS, JSON.stringify(State.points));
    localStorage.setItem(this.STORAGE_KEYS.HISTORY, JSON.stringify(State.pointsHistory));
    localStorage.setItem(this.STORAGE_KEYS.EVENTS, JSON.stringify(State.activeEvents));
    localStorage.setItem(this.STORAGE_KEYS.CURRENT_EVENT, document.getElementById('result').innerHTML);
  }
};

// ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–ß–ö–ê–ú–ò (POINTS MANAGER) ============
const PointsManager = {
  addRoundPoints() {
    const getValue = id => parseInt(document.getElementById(id).value) || 0;
    const roundK = getValue('round-score-K');
    const roundV = getValue('round-score-V');
    const roundA = getValue('round-score-A');
    
    if (roundK === 0 && roundV === 0 && roundA === 0) {
      if (!confirm("–í—Å–µ –ø–æ–ª—è —Ä–∞–≤–Ω—ã 0. –í—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?")) {
        this.clearInputs();
        return;
      }
    }
    
    State.points.K += roundK;
    State.points.V += roundV;
    State.points.A += roundA;
    
    State.pointsHistory.K.push(State.points.K);
    State.pointsHistory.V.push(State.points.V);
    State.pointsHistory.A.push(State.points.A);
    
    this.updatePointsDisplay();
    ChartManager.updateChart();
    DataManager.saveAll();
    this.clearInputs();
    
    Utils.showNotification(`–û—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã: –ö +${roundK}, –í +${roundV}, –ê +${roundA}`);
  },
  
  clearInputs() {
    ['round-score-K', 'round-score-V', 'round-score-A'].forEach(id => {
      document.getElementById(id).value = '';
    });
  },
  
  resetAllPoints() {
    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –æ—á–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—é?")) {
      State.points = { K: 0, V: 0, A: 0 };
      State.pointsHistory = { K: [], V: [], A: [] };
      this.updatePointsDisplay();
      ChartManager.updateChart();
      localStorage.removeItem(DataManager.STORAGE_KEYS.POINTS);
      localStorage.removeItem(DataManager.STORAGE_KEYS.HISTORY);
      Utils.showNotification("–í—Å–µ –æ—á–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω—ã");
    }
  },
  
  clearHistory() {
    if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—É–Ω–¥–æ–≤? –¢–µ–∫—É—â–∏–µ –æ—á–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è.")) {
      State.pointsHistory = { K: [], V: [], A: [] };
      ChartManager.updateChart();
      localStorage.removeItem(DataManager.STORAGE_KEYS.HISTORY);
      Utils.showNotification("–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤ –æ—á–∏—â–µ–Ω–∞");
    }
  },
  
  updatePointsDisplay() {
    document.getElementById('total-points-K').innerText = State.points.K;
    document.getElementById('total-points-V').innerText = State.points.V;
    document.getElementById('total-points-A').innerText = State.points.A;
  }
};

// ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–ë–ï–î–ê–ú–ò (SCORE MANAGER) ============
const ScoreManager = {
  addWin(player) {
    State.wins[player]++;
    this.updateWinsDisplay();
    DataManager.saveAll();
    this.updateTotalGames();
  },
  
  resetWins() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ–±–µ–¥—ã?")) {
      State.wins = { K: 0, V: 0, A: 0 };
      this.updateWinsDisplay();
      localStorage.removeItem(DataManager.STORAGE_KEYS.WINS);
      this.updateTotalGames();
    }
  },
  
  updateWinsDisplay() {
    document.getElementById('score-K').innerText = State.wins.K;
    document.getElementById('score-V').innerText = State.wins.V;
    document.getElementById('score-A').innerText = State.wins.A;
  },
  
  updateTotalGames() {
    const total = State.wins.K + State.wins.V + State.wins.A;
    document.getElementById('total-count').innerText = total;
  }
};

// ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–í–ï–ù–¢–ê–ú–ò (EVENT MANAGER) ============
const EventManager = {
  rollEvent() {
    const t = Utils.randomChoice(TRIGGERS);
    const a = Utils.randomChoice(ACTIONS);
    const e = Utils.randomChoice(EFFECTS);
    const text = `${t} ‚Äî ${a} ${e}.`;
    const timestamp = new Date();
    const datetime = Utils.formatDateTime(timestamp);
    
    State.activeEvents.unshift({ 
      text, 
      date: datetime.date,
      time: datetime.time,
      full: datetime.full,
      timestamp: timestamp.toISOString() 
    });
    
    const eventHTML = `
      <strong>üé≤ –ê–∫—Ç–∏–≤–Ω—ã–π –∏–≤–µ–Ω—Ç:</strong><br>${text}
      <span class="current-event-time">
        ${datetime.date}<br>
        ${datetime.time}
      </span>
    `;
    
    document.getElementById('result').innerHTML = eventHTML;
    this.renderEvents();
    DataManager.saveAll();
  },
  
  renderEvents() {
    const container = document.getElementById('events');
    container.innerHTML = `
      <div class="events-header">
        <h3 style="margin: 0;">–ü—Ä–æ—à–ª—ã–µ –∏–≤–µ–Ω—Ç—ã</h3>
        <button onclick="EventManager.clearAllEvents()" style="font-size: 14px; padding: 5px 10px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
      </div>
    `;
    
    State.activeEvents.forEach((ev, index) => {
      const eventElement = document.createElement('div');
      eventElement.className = `event ${ev.custom ? 'custom-event' : ''}`;
      eventElement.innerHTML = `
        <div class="event-content">
          ${ev.text}
          <span class="event-time">
            ${ev.date}<br>
            ${ev.time}
          </span>
        </div>
        <button class="delete-event-btn" onclick="EventManager.deleteEvent(${index})" title="–£–¥–∞–ª–∏—Ç—å –∏–≤–µ–Ω—Ç">üóëÔ∏è</button>
      `;
      container.appendChild(eventElement);
    });
    
    if (State.activeEvents.length === 0) {
      const emptyMessage = document.createElement('div');
      emptyMessage.className = 'event';
      emptyMessage.innerHTML = '<div style="color: #888; text-align: center; width: 100%;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–≤–µ–Ω—Ç–æ–≤</div>';
      container.appendChild(emptyMessage);
    }
  },
  
  deleteEvent(index) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∏–≤–µ–Ω—Ç?")) {
      State.activeEvents.splice(index, 1);
      this.renderEvents();
      DataManager.saveAll();
      Utils.showNotification("–ò–≤–µ–Ω—Ç —É–¥–∞–ª—ë–Ω");
    }
  },
  
  clearAllEvents() {
    if (confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–≤–µ–Ω—Ç—ã?")) {
      State.activeEvents = [];
      this.renderEvents();
      DataManager.saveAll();
      Utils.showNotification("–í—Å–µ –∏–≤–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã");
    }
  },
  
  resetGame() {
    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–≤–µ–Ω—Ç—ã?")) {
      State.activeEvents = [];
      document.getElementById('result').innerHTML = '';
      this.renderEvents();
      localStorage.removeItem(DataManager.STORAGE_KEYS.EVENTS);
      localStorage.removeItem(DataManager.STORAGE_KEYS.CURRENT_EVENT);
      Utils.showNotification("–í—Å–µ –∏–≤–µ–Ω—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã");
    }
  }
};

// ============ –ö–ê–°–¢–û–ú–ù–´–ï –ò–í–ï–ù–¢–´ (CUSTOM EVENT MANAGER) ============
const CustomEventManager = {
  openDialog() {
    document.getElementById('custom-event-dialog').style.display = 'flex';
    document.getElementById('custom-event-text').focus();
  },
  
  closeDialog() {
    document.getElementById('custom-event-dialog').style.display = 'none';
    document.getElementById('custom-event-text').value = '';
  },
  
  addCustomEvent() {
    const text = document.getElementById('custom-event-text').value.trim();
    if (!text) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–≤–µ–Ω—Ç–∞');
      return;
    }
    
    const timestamp = new Date();
    const datetime = Utils.formatDateTime(timestamp);
    
    State.activeEvents.unshift({ 
      text: text + ' (—Ä—É—á–Ω–æ–π)', 
      date: datetime.date,
      time: datetime.time,
      full: datetime.full,
      timestamp: timestamp.toISOString(),
      custom: true // –º–µ—Ç–∫–∞, —á—Ç–æ —ç—Ç–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π –∏–≤–µ–Ω—Ç
    });
    
    const eventHTML = `
      <strong>‚úçÔ∏è –ê–∫—Ç–∏–≤–Ω—ã–π –∏–≤–µ–Ω—Ç (—Ä—É—á–Ω–æ–π):</strong><br>${text}
      <span class="current-event-time">
        ${datetime.date}<br>
        ${datetime.time}
      </span>
    `;
    
    document.getElementById('result').innerHTML = eventHTML;
    EventManager.renderEvents();
    DataManager.saveAll();
    this.closeDialog();
    
    Utils.showNotification('‚úÖ –†—É—á–Ω–æ–π –∏–≤–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
  }
};

// ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ì–†–ê–§–ò–ö–û–ú (CHART MANAGER) ============
const ChartManager = {
  updateChart() {
    const canvas = document.getElementById('points-chart');
    const ctx = canvas.getContext('2d');
    
    canvas.width = canvas.offsetWidth;
    canvas.height = 250;
    
    if (State.chart) State.chart.destroy();
    
    const labels = [];
    const maxRounds = Math.max(
      State.pointsHistory.K.length, 
      State.pointsHistory.V.length, 
      State.pointsHistory.A.length
    );
    
    for (let i = 1; i <= maxRounds; i++) labels.push(`–†–∞—É–Ω–¥ ${i}`);
    
    if (maxRounds === 0) {
      labels.push('–¢–µ–∫—É—â–∏–µ');
      const displayHistory = {
        K: [State.points.K],
        V: [State.points.V],
        A: [State.points.A]
      };
      State.chart = this._createChart(ctx, labels, displayHistory);
      return;
    }
    
    State.chart = this._createChart(ctx, labels, State.pointsHistory);
  },
  
  _createChart(ctx, labels, historyData) {
    const allPoints = [...historyData.K, ...historyData.V, ...historyData.A];
    const maxValue = Math.max(...allPoints, 10);
    
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          this._createDataset('–ö', historyData.K, COLORS.K),
          this._createDataset('–í', historyData.V, COLORS.V),
          this._createDataset('–ê', historyData.A, COLORS.A)
        ]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#ccc',
              font: { size: 12 },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#444',
            borderWidth: 1,
            callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw} –æ—á–∫–æ–≤` }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: {
              color: '#aaa',
              font: { size: 12 },
              callback: value => value + ' –æ—á–∫–æ–≤'
            },
            title: {
              display: true,
              text: '–û—á–∫–∏',
              color: '#ccc',
              font: { size: 14 }
            },
            suggestedMax: maxValue * 1.1
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: {
              color: '#aaa',
              font: { size: 11 },
              maxRotation: 45,
              autoSkip: false,
              maxTicksLimit: 50
            },
            title: {
              display: true,
              text: '–†–∞—É–Ω–¥—ã',
              color: '#ccc',
              font: { size: 14 }
            }
          }
        },
        interaction: { intersect: false, mode: 'nearest' },
        animation: { duration: 1000, easing: 'easeOutQuart' },
        elements: {
          point: { hoverBorderWidth: 2 },
          line: { tension: 0.2 }
        }
      }
    });
  },
  
  _createDataset(label, data, color) {
    return {
      label,
      data,
      borderColor: color,
      backgroundColor: 'transparent',
      borderWidth: 3,
      fill: false,
      tension: 0.2,
      pointRadius: 3,
      pointHoverRadius: 6,
      pointBackgroundColor: color,
      pointBorderColor: '#fff',
      pointBorderWidth: 1
    };
  }
};

// ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
function initializeApp() {
  DataManager.loadAllData();
  ScoreManager.updateWinsDisplay();
  PointsManager.updatePointsDisplay();
  ScoreManager.updateTotalGames();
  EventManager.renderEvents();
  
  setTimeout(() => ChartManager.updateChart(), 100);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
  const hasBackup = localStorage.getItem(DataManager.STORAGE_KEYS.BACKUP);
  if (hasBackup) {
    setTimeout(() => {
      if (confirm('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –≤ localStorage. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—ë?')) {
        DataManager.restoreBackup();
      }
    }, 1000);
  }
}

// ============ –°–õ–£–®–ê–¢–ï–õ–ò –°–û–ë–´–¢–ò–ô ============
window.addEventListener('DOMContentLoaded', initializeApp);
window.addEventListener('resize', () => {
  if (State.chart) ChartManager.updateChart();
});

// –ê–Ω–∏–º–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    15% { opacity: 1; transform: translateY(0); }
    85% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
  }
`;
document.head.appendChild(style);

let isClockwise = true; // true = ‚Üª, false = ‚Ü∫

function toggleCircleArrow() {
  const button = document.getElementById('circle-arrow-clicker');
  
  if (isClockwise) {
    button.textContent = '‚Ü∫';
    button.title = "–°—Ç—Ä–µ–ª–∫–∞ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π";
    isClockwise = false;
  } else {
    button.textContent = '‚Üª';
    button.title = "–°—Ç—Ä–µ–ª–∫–∞ –ø–æ —á–∞—Å–æ–≤–æ–π";
    isClockwise = true;
  }
  
  // –õ–µ–≥–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è
  button.style.transform = 'scale(0.95)';
  setTimeout(() => {
    button.style.transform = 'scale(1)';
  }, 100);
}

function toggleInfoPopup() {
  const popup = document.getElementById('info-popup');
  const button = document.getElementById('info-button');
  
  if (popup.style.display === 'flex') {
    popup.style.display = 'none';
    button.style.background = 'transparent';
    button.style.color = '#aaa';
    button.style.borderColor = '#555';
  } else {
    popup.style.display = 'flex';
    button.style.background = '#2c3e50';
    button.style.color = '#fff';
    button.style.borderColor = '#4ECDC4';
  }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
document.getElementById('info-popup').addEventListener('click', function(e) {
  if (e.target === this) {
    toggleInfoPopup();
  }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('info-popup').style.display === 'flex') {
    toggleInfoPopup();
  }
});
</script>

<div id="info-popup" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 2000;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: #1a1a1a;
    border: 2px solid #444;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  ">
    <div style="
      background: #2c3e50;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
    ">
      <h3 style="margin: 0; color: #fff;">‚ÑπÔ∏è –ü–æ–ª–æ–∂–Ω—è–∫ –ø–æ –∏–≥—Ä–µ</h3>
      <button onclick="toggleInfoPopup()" style="
        background: transparent;
        border: none;
        color: #aaa;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      ">√ó</button>
    </div>
    <div id="info-content" style="
      padding: 20px;
      overflow-y: auto;
      color: #ccc;
      line-height: 1.5;
      flex-grow: 1;
    ">
      <!-- –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ —Å–Ω–æ—Å–∫–∏ –∏ —á–µ–π–Ω–¥–∂–ª–æ–≥–∏ –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ -->
      <h4 style="color: #fff; margin-top: 0;">–ö—Ç–æ —á–µ –ø–æ–ª—É—á–∞–µ—Ç</h4>
      <ul style="padding-left: 20px;">
        <li>1 –º–µ—Å—Ç–æ - –∑–∞–±–∞–≤–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</li>
        <li>2 –º–µ—Å—Ç–æ - –≤–µ—Å—å —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å —Ö–æ–¥–∏—Ç —Å –∫–ª–æ—É–Ω—Å–∫–∏–º –Ω–æ—Å–æ–º</li>
        <li>3 –º–µ—Å—Ç–æ - –¥–µ–ª–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä–Ω—É—é –∑–∞—Ä—è–¥–∫—É –∏–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è Seven</li>
      </ul>
      
      <h4 style="color: #fff; margin-top: 20px;">–ó–∞–º–µ—Ç–∫–∏ –ø–æ –∏–≥—Ä–µ</h4>
      <p>–í—ã, –∫–æ—Ä–æ—á–µ, —Ö–æ–¥–∏—Ç–µ –ø–æ –æ—á–µ—Ä–µ–¥–∏ –∏ –∫–ª–∞–¥–µ—Ç–µ –∫–∞—Ä—Ç—ã.</p>
      
      <h4 style="color: #fff; margin-top: 20px;">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ GTA 6</h4>
      <p>19 –Ω–æ—è–±—Ä—è 2026 –≥–æ–¥–∞</p>
      
      <!-- –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏ –∑–¥–µ—Å—å -->
    </div>
    <div style="
      background: #222;
      padding: 10px 20px;
      border-top: 1px solid #444;
      text-align: center;
      font-size: 12px;
      color: #888;
    ">
      –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –ø—Ä—è–º–æ –≤ HTML-–∫–æ–¥–µ
    </div>
  </div>
</div>
</body>
</html>



